<!doctype html>
<title>Container Relative Units: Invalidation</title>
<link rel="help" href="https://drafts.csswg.org/css-contain-3/#container-lengths">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="support/cq-testcommon.js"></script>
<style>
  #inline { container-type: inline-size; }
  #size, #outer { container-type: size; }
  .h600 { height: 600px; }
  .w500 { width: 500px; }
  .h400 { height: 400px; }
  .w300 { width: 300px; }
  #child {
    padding-left: 10cqi;
    padding-right: 10cqb;
  }
</style>
<div id=ref></div>
<div id=outer class="h600">
  <div id=size class="w500 h400">
    <div id=inline class="w300">
      <div id=child>Test</div>
    </div>
  </div>
</div>
<script>
  setup(() => assert_implements_container_queries());

  function assert_cqi_equals(element, expected) {
    assert_equals(getComputedStyle(element).paddingLeft, expected);
  }

  function assert_cqb_equals(element, expected) {
    assert_equals(getComputedStyle(element).paddingRight, expected);
  }

  promise_test(async t => {
    if (waitForPolyfill) await waitForPolyfill();
    assert_cqi_equals(child, '30px');

    try {
      inline.style.containerType = 'normal';
      if (waitForPolyfill) await waitForPolyfill();
      assert_cqi_equals(child, '50px');
    } finally {
      inline.style = '';
    }

    if (waitForPolyfill) await waitForPolyfill();
    assert_cqi_equals(child, '30px');
  }, `cqi respond when selected container changes type (inline-size -> normal)`);

  promise_test(async () => {
    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');

    try {
      size.style.containerType = 'normal';
      if (waitForPolyfill) await waitForPolyfill();
      assert_cqb_equals(child, '60px');
    } finally {
      size.style = '';
    }

    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');
  }, `cqb respond when selected container changes type (size -> normal)`);

  promise_test(async () => {
    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');

    try {
      inline.style.containerType = 'size';
      inline.style.height = '200px';
      if (waitForPolyfill) await waitForPolyfill();
      assert_cqb_equals(child, '20px');
    } finally {
      inline.style = '';
    }

    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');
  }, `cqb respond when intermediate container changes type (inline-size -> size)`);

  promise_test(async () => {
    if (waitForPolyfill) await waitForPolyfill();
    assert_cqi_equals(child, '30px');

    try {
      inline.style.width = '50px';
      if (waitForPolyfill) await waitForPolyfill();
      assert_cqi_equals(child, '5px');
    } finally {
      inline.style = '';
    }

    if (waitForPolyfill) await waitForPolyfill();
    assert_cqi_equals(child, '30px');
  }, 'cqi respond when selected container changes inline-size');

  promise_test(async () => {
    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');

    try {
      size.style.height = '50px';
      if (waitForPolyfill) await waitForPolyfill();
      assert_cqb_equals(child, '5px');
    } finally {
      size.style = '';
    }

    if (waitForPolyfill) await waitForPolyfill();
    assert_cqb_equals(child, '40px');
  }, 'cqb respond when selected container changes block-size');
</script>
